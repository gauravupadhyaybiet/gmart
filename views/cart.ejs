

<% layout("/layouts/boilerplate") %>

<h1 class="text-center mb-4">Your Cart</h1>

<% if (cartItems && cartItems.length > 0) { %>

<div class="cart-container">

<% cartItems.forEach(item => {

   /* ================= SAFE CHECK ================= */
   if(!item.productId){
      return;   // skip deleted products
   }

   const product = item.productId;

   const price = product.amount || 0;
   const discount = product.discount || 0;
   const quantity = item.quantity || 1;

   const discountedPrice =
      discount > 0
      ? price - (price * discount / 100)
      : price;

   const totalPrice = Math.round(discountedPrice * quantity);

%>

<div class="cart-item">

<div class="card">

<img src="<%= product.image || '/no-image.png' %>"
     class="card-img-top"
     alt="<%= product.name || 'Product' %>">

<div class="card-body">

<h5 class="card-title">
  <%= product.name || 'Unnamed product' %>
</h5>

<p class="price">

<span class="discounted">
₹<%= totalPrice %>
</span>

<% if(discount > 0){ %>

<span class="original">
₹<%= price * quantity %>
</span>

<span class="badge bg-warning text-dark ms-2">
<%= discount %>% OFF
</span>

<% } %>

</p>

<button
 class="btn btn-primary pay-now"
 data-amount="<%= totalPrice %>"
 data-product-name="<%= (product.name||'Product').replace(/'/g,'\\\'') %>"
>
Pay Now
</button>

</div>
</div>

<form method="POST"
      action="/cart/<%= item._id %>/delete?_method=DELETE">

<button class="btn btn-danger w-100 mt-2">
Delete
</button>

</form>

</div>

<% }) %>

</div>

<% } else { %>

<p class="empty-cart text-center">
Your cart is empty.
</p>

<% } %>



<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>

function payNow(amount, productName){

fetch('/order',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({amount})
})
.then(res=>res.json())
.then(order=>{

const options={
key:'rzp_test_tf9CPdWCcLlH39',
amount:order.amount,
currency:order.currency,
name:productName,
order_id:order.id,

handler:function(response){

fetch('/verifypayment',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
order_id:order.id,
payment_id:response.razorpay_payment_id,
signature:response.razorpay_signature
})
})
.then(r=>r.text())
.then(msg=>alert(msg));

}
};

new Razorpay(options).open();

});

}


document.querySelectorAll('.pay-now').forEach(btn=>{

btn.addEventListener('click',function(){

payNow(
this.dataset.amount,
this.dataset.productName
);

});

});

</script>



